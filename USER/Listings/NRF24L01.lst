C51 COMPILER V9.56.0.0   NRF24L01                                                          01/01/2019 22:52:34 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE NRF24L01
OBJECT MODULE PLACED IN ..\OBJ\NRF24L01.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_v5\C51\BIN\C51.EXE ..\HARDWARE\NRF24L01\NRF24L01.c OPTIMIZE(8,SPEED) BR
                    -OWSE INCDIR(..\USER;..\SYSTEM;..\SYSTEM\delay;..\SYSTEM\uart;..\SYSTEM\adc;..\SYSTEM\eeprom;..\SYSTEM\timer;..\SYSTEM\pc
                    -a;..\SYSTEM\spi;..\HARDWARE\NRF24L01;..\HARDWARE\Rocker;..\APP\NRF_DT) DEFINE(STC_Y5,FOSC=11059200L,UART_BAUD=115200,UAR
                    -T_PARITYBIT=ODD_PARITY,TEST_MODE=1,NRF_CAR_SLAVE,ROCKER_SUM=1) DEBUG OBJECTEXTEND PRINT(.\Listings\NRF24L01.lst) OBJECT(
                    -..\OBJ\NRF24L01.obj)

line level    source

   1          #include "NRF24L01.h"
   2          #include "spi.h"
   3          
   4          extern volatile bit SPI_Busy_Flag;
   5          
   6          const uint8_t TX_ADDRESS[TX_ADR_WIDTH]={0x34,0x43,0x10,0x10,0x01}; //·¢ËÍµØÖ·
   7          const uint8_t RX_ADDRESS[RX_ADR_WIDTH]={0x34,0x43,0x10,0x10,0x01}; //·¢ËÍµØÖ·
   8          
   9          volatile uint8_t TX_PLOAD_WIDTH = 8;//MAX 32×Ö½ÚµÄÓÃ»§Êý¾Ý¿í¶È
  10          volatile uint8_t RX_PLOAD_WIDTH = 8;//MAX 32×Ö½ÚµÄÓÃ»§Êý¾Ý¿í¶È
  11          
  12          /**********************************************************************
  13          -  Function :           void NRF24L01_Init(void)
  14          -  Description :        NRF24L01³õÊ¼»¯
  15          -  Input :                      void
  16          -  Return :                     void
  17          -  Others :                     NRF24L01_CE                     -> P5^4 
  18                                                  NRF24L01_SPI_CSN        -> P1^2
  19                                                  NRF24L01_SPI_MOSI       -> P1^3
  20                                                  NRF24L01_SPI_MISO       -> P1^4
  21                                                  NRF24L01_SPI_SCLK       -> P1^5
  22                                                  NRF24L01_IRQ            -> P3^2
  23          **********************************************************************/
  24          void NRF24L01_Init(void)
  25          {
  26   1              //IO Mode:
  27   1              //NRF24L01_CE           PP                      O
  28   1              //NRF24L01_SPI_CSN      PP                      O
  29   1              //NRF24L01_SPI_MOSI     PP                      O
  30   1              //NRF24L01_SPI_MISO     ×¼Ë«ÏòIO        I
  31   1              //NRF24L01_SPI_SCLK     PP                      O
  32   1              P2M0 &= 0xEF;
  33   1              P2M0 |= 0x2C;
  34   1              P2M1 &= 0xC3;
  35   1              P2M1 |= 0x00;
  36   1              NRF24L01_SPI_CSN  = 1; //SPIÆ¬Ñ¡È¡Ïû
  37   1              NRF24L01_SPI_MOSI = 1; //Ç¿ÉÏÀ­
  38   1              NRF24L01_SPI_MISO = 1; //ÈõÉÏÀ­
  39   1              NRF24L01_SPI_SCLK = 0; //´®ÐÐÍ¬²½Ê±ÖÓµÄ¿ÕÏÐ×´Ì¬ÎªµÍ
  40   1              
  41   1              //NRF24L01_CE           PP                      O
  42   1              P5M0 &= 0xFF;
  43   1              P5M0 |= 0x20;
  44   1              P5M1 &= 0xDF;
  45   1              P5M1 |= 0x00;
  46   1              NRF24L01_CE = 1; //È¥ÄÜNRF24L01
  47   1              
  48   1              //NRF24L01_IRQ          ×¼Ë«ÏòIO        I
  49   1              P3M0 &= 0xF7;
  50   1              P3M0 |= 0x00;
  51   1              P3M1 &= 0xF7;
C51 COMPILER V9.56.0.0   NRF24L01                                                          01/01/2019 22:52:34 PAGE 2   

  52   1              P3M1 |= 0x00;
  53   1              NRF24L01_IRQ = 1; //À­¸ßNRF24L01_IRQ,×¼±¸¶ÁÈ¡NRF24L01_IRQ
  54   1              
  55   1              
  56   1              SPI_Init();//³õÊ¼»¯NRF24L01_SPI
  57   1              
  58   1              SPI_Busy_Flag = 0;
  59   1              NRF24L01_CE = 0; //Enable NRF24L01
  60   1              NRF24L01_SPI_CSN  = 1; //SPIÆ¬Ñ¡È¡Ïû
  61   1      }
  62          
  63          /**********************************************************************
  64          -  Function :           void NRF24L01_Init(void)
  65          -  Description :        ¼ì²âNRF24L01ÊÇ·ñ´æÔÚ
  66          -  Input :                      void
  67          -  Return :                     uint8_t 0:³É¹¦;1:Ê§°Ü
  68          -  Others :                     Í¨¹ýÐ´·¢ËÍµØÖ·ÅÐ±ðSPIÊÇ·ñÁªÍ¨
  69          **********************************************************************/
  70          uint8_t NRF24L01_Check(void)
  71          {
  72   1              volatile uint8_t buf[5]={0XA5, 0XA5, 0XA5, 0XA5, 0XA5};
  73   1              uint8_t i;
  74   1              
  75   1              NRF24L01_Write_Buf(NRF_WRITE_REG+TX_ADDR, buf, 5);//Ð´Èë5¸ö×Ö½ÚµÄµØÖ·.          
  76   1              NRF24L01_Read_Buf(TX_ADDR, buf, 5); //¶Á³öÐ´ÈëµÄµØÖ·
  77   1              for(i=0;i<5;i++)
  78   1                      if(buf[i]!=0xA5) break;                                                            
  79   1              
  80   1              if(i!=5)return 1;//¼ì²â24L01´íÎó        
  81   1              return 0;                //¼ì²âµ½24L01
  82   1      }
  83          
  84          /**********************************************************************
  85          -  Function :           uint8_t NRF24L01_Write_Reg(uint8_t reg, uint8_t Data)
  86          -  Description :        Ð´¼Ä´æÆ÷
  87          -  Input :                      uint8_t reg: ¼Ä´æÆ÷µØÖ·
  88                                                  uint8_t Data: Ð´ÈëµÄÊý¾Ý
  89          -  Return :                     uint8_t status: ×´Ì¬Öµ
  90          -  Others :                     
  91          **********************************************************************/
  92          uint8_t NRF24L01_Write_Reg(uint8_t Reg, uint8_t Data)
  93          {
  94   1              uint8_t status;
  95   1              
  96   1              NRF24L01_SPI_CSN = 0;                           //Ê¹ÄÜSPI´«Êä
  97   1              status = SPI_ReadWriteByte(Reg);        //·¢ËÍ¼Ä´æÆ÷ºÅ
  98   1              SPI_ReadWriteByte(Data);                        //Ð´Èë¼Ä´æÆ÷µÄÖµ
  99   1              NRF24L01_SPI_CSN = 1;                           //È¥ÄÜSPI´«Êä
 100   1              
 101   1              return (status);                                        //·µ»Ø×´Ì¬Öµ
 102   1      }
 103          
 104          /**********************************************************************
 105          -  Function :           uint8_t NRF24L01_Read_Reg(uint8_t reg)
 106          -  Description :        ¶ÁÈ¡¼Ä´æÆ÷
 107          -  Input :                      uint8_t reg: ¼Ä´æÆ÷µØÖ·
 108          -  Return :                     uint8_t Reg_Data: ¼Ä´æÆ÷µÄÖµ
 109          -  Others :                     
 110          **********************************************************************/
 111          uint8_t NRF24L01_Read_Reg(uint8_t Reg)
 112          {
 113   1              uint8_t Reg_Data;
C51 COMPILER V9.56.0.0   NRF24L01                                                          01/01/2019 22:52:34 PAGE 3   

 114   1              
 115   1              NRF24L01_SPI_CSN = 0;                           //Ê¹ÄÜSPI´«Êä
 116   1              SPI_ReadWriteByte(Reg);                         //·¢ËÍ¼Ä´æÆ÷ºÅ
 117   1              Reg_Data = SPI_ReadWriteByte(0xFF);     //¶ÁÈ¡¼Ä´æÆ÷µÄÖµ
 118   1              NRF24L01_SPI_CSN = 1;                           //È¥ÄÜSPI´«Êä
 119   1              
 120   1              return (Reg_Data);                                      //·µ»Ø×´Ì¬Öµ
 121   1      }
 122          
 123          /**********************************************************************
 124          -  Function :           uint8_t NRF24L01_Read_Buf(uint8_t, uint8_t*, uint8_t)
 125          -  Description :        ÔÚÖ¸¶¨Î»ÖÃ¶Á³öÖ¸¶¨³¤¶ÈµÄÊý¾Ý
 126          -  Input :                      uint8_t reg: ¼Ä´æÆ÷µØÖ·
 127                                                  uint8_t *pBuf: Êý¾ÝÖ¸Õë
 128                                                  uint8_t len: Êý¾Ý³¤¶È
 129          -  Return :                     uint8_t Reg_Data: ¼Ä´æÆ÷µÄÖµ
 130          -  Others :                     
 131          **********************************************************************/
 132          uint8_t NRF24L01_Read_Buf(uint8_t Reg, uint8_t *p_Buf, uint8_t Len)
 133          {
 134   1              uint8_t status, u8_ctr;
 135   1              
 136   1              NRF24L01_SPI_CSN = 0;                           //Ê¹ÄÜSPI´«Êä
 137   1              status = SPI_ReadWriteByte(Reg);        //·¢ËÍ¼Ä´æÆ÷ºÅ
 138   1              for(u8_ctr=0; u8_ctr<Len; u8_ctr++) //¶Á³öÊý¾Ý
 139   1                      p_Buf[u8_ctr] = SPI_ReadWriteByte(0xFF);
 140   1              NRF24L01_SPI_CSN = 1;                           //È¥ÄÜSPI´«Êä
 141   1              
 142   1              return (status);                                        //·µ»Ø×´Ì¬Öµ
 143   1      }
 144          
 145          /**********************************************************************
 146          -  Function :           uint8_t NRF24L01_Write_Buf(uint8_t, uint8_t*, uint8_t)
 147          -  Description :        ÔÚÖ¸¶¨Î»ÖÃÐ´ÈëÖ¸¶¨³¤¶ÈµÄÊý¾Ý
 148          -  Input :                      uint8_t reg: ¼Ä´æÆ÷µØÖ·
 149                                                  uint8_t *pBuf: Êý¾ÝÖ¸Õë
 150                                                  uint8_t len: Êý¾Ý³¤¶È
 151          -  Return :                     uint8_t status: ×´Ì¬Öµ
 152          -  Others :                     
 153          **********************************************************************/
 154          uint8_t NRF24L01_Write_Buf(uint8_t Reg, uint8_t *p_Buf, uint8_t Len)
 155          {
 156   1              uint8_t status,u8_ctr;
 157   1              
 158   1      //      EA = 0;
 159   1              NRF24L01_SPI_CSN = 0;                           //Ê¹ÄÜSPI´«Êä
 160   1              status = SPI_ReadWriteByte(Reg);        //·¢ËÍ¼Ä´æÆ÷ºÅ
 161   1              for(u8_ctr=0; u8_ctr<Len; u8_ctr++)     //Ð´ÈëÊý¾Ý
 162   1                      SPI_ReadWriteByte(*p_Buf++);
 163   1              NRF24L01_SPI_CSN = 1;                           //È¥ÄÜSPI´«Êä
 164   1      //      EA = 1;
 165   1              
 166   1              return (status);                                        //·µ»Ø×´Ì¬Öµ
 167   1      }
 168          
 169          /**********************************************************************
 170          -  Function :           uint8_t NRF24L01_TxPacket(uint8_t *TxBuf)
 171          -  Description :        Æô¶¯NRF24L01·¢ËÍÒ»´ÎÊý¾Ý
 172          -  Input :                      uint8_t *TxBuf: ´ý·¢ËÍÊý¾ÝÊ×µØÖ·
 173          -  Return :                     uint8_t status: ×´Ì¬Öµ
 174          -  Others :                     
 175          **********************************************************************/
C51 COMPILER V9.56.0.0   NRF24L01                                                          01/01/2019 22:52:34 PAGE 4   

 176          uint8_t NRF24L01_TxPacket(uint8_t *TxBuf)
 177          {
 178   1              uint8_t sta;
 179   1              
 180   1              NRF24L01_CE = 0;
 181   1              NRF24L01_Write_Buf(WR_TX_PLOAD, TxBuf, TX_PLOAD_WIDTH);//Ð´Êý¾Ýµ½TX BUF TX_PLOAD_WIDTH¸ö×Ö½Ú
 182   1              NRF24L01_CE = 1;                                //Æô¶¯·¢ËÍ
 183   1              while(NRF24L01_IRQ == 0);               //µÈ´ý·¢ËÍÍê±Ï
 184   1              sta = NRF24L01_Read_Reg(STATUS);//¶ÁÈ¡×´Ì¬¼Ä´æÆ÷µÄÖµ
 185   1              NRF24L01_Write_Reg(NRF_WRITE_REG+STATUS, sta);//Çå³ýTX_DS»òMAX_RTÖÐ¶Ï±êÖ¾
 186   1              
 187   1              if(sta&MAX_TX)//´ïµ½×î´óÖØ·¢´ÎÊý
 188   1              {
 189   2                      NRF24L01_Write_Reg(FLUSH_TX, 0xFF);//Çå³ýTX FIFO¼Ä´æÆ÷
 190   2                      return MAX_TX;
 191   2              }
 192   1              if(sta&TX_OK)//·¢ËÍÍê³É
 193   1              {
 194   2                      return TX_OK;
 195   2              }
 196   1              return 0xFF;//ÆäËûÔ­Òò·¢ËÍÊ§°Ü
 197   1      }
 198          
 199          /**********************************************************************
 200          -  Function :           uint8_t NRF24L01_RxPacket(uint8_t *RxBuf)
 201          -  Description :        Æô¶¯NRF24L01½ÓÊÕÒ»¸ö°üµÄÊý¾Ý
 202          -  Input :                      uint8_t *RxBuf: ½ÓÊÕÊý¾ÝÊ×µØÖ·
 203          -  Return :                     uint8_t status: ×´Ì¬Öµ
 204          -  Others :                     
 205          **********************************************************************/
 206          uint8_t NRF24L01_RxPacket(uint8_t *RxBuf)
 207          {
 208   1              uint8_t sta;
 209   1              
 210   1              sta = NRF24L01_Read_Reg(STATUS);//¶ÁÈ¡×´Ì¬¼Ä´æÆ÷µÄÖµ
 211   1              NRF24L01_Write_Reg(NRF_WRITE_REG+STATUS, sta);//Çå³ýTX_DS»òMAX_RTÖÐ¶Ï±êÖ¾
 212   1              if(sta&RX_OK)
 213   1              {
 214   2                      NRF24L01_Read_Buf(RD_RX_PLOAD, RxBuf, RX_PLOAD_WIDTH);//¶ÁÈ¡Êý¾Ý
 215   2                      NRF24L01_Write_Reg(FLUSH_TX, 0xFF);//Çå³ýTX FIFO¼Ä´æÆ÷
 216   2                      return 0;
 217   2              }
 218   1              return 1;//Ã»ÓÐÊÕµ½ÈÎºÎÊý¾Ý
 219   1      }
 220          
 221          
 222          /**********************************************************************
 223          -  Function :           void NRF24L01_RX_Mode(void)
 224          -  Description :        ³õÊ¼»¯NRF24L01µ½RXÄ£Ê½
 225          -  Input :                      void
 226          -  Return :                     void
 227          -  Others :                     
 228          **********************************************************************/
 229          void NRF24L01_RX_Mode(void)
 230          {
 231   1              NRF24L01_CE=0;
 232   1              NRF24L01_Write_Buf(NRF_WRITE_REG+RX_ADDR_P0, 
 233   1                      (uint8_t*)RX_ADDRESS, RX_ADR_WIDTH);//Ð´RX½ÚµãµØÖ·
 234   1                
 235   1              NRF24L01_Write_Reg(NRF_WRITE_REG+EN_AA, 0x01);    //Ê¹ÄÜÍ¨µÀ0µÄ×Ô¶¯Ó¦´ð    
 236   1              NRF24L01_Write_Reg(NRF_WRITE_REG+EN_RXADDR, 0x01);//Ê¹ÄÜÍ¨µÀ0µÄ½ÓÊÕµØÖ·          
 237   1              NRF24L01_Write_Reg(NRF_WRITE_REG+RF_CH, 40);         //ÉèÖÃRFÍ¨ÐÅÆµÂÊ             
C51 COMPILER V9.56.0.0   NRF24L01                                                          01/01/2019 22:52:34 PAGE 5   

 238   1              NRF24L01_Write_Reg(NRF_WRITE_REG+RX_PW_P0, RX_PLOAD_WIDTH);//Ñ¡ÔñÍ¨µÀ0µÄÓÐÐ§Êý¾Ý¿í¶È        
 239   1              NRF24L01_Write_Reg(NRF_WRITE_REG+RF_SETUP, 0x0f);//ÉèÖÃTX·¢Éä²ÎÊý,0dbÔöÒæ,2Mbps,µÍÔëÉùÔöÒæ¿ªÆô   
 240   1              NRF24L01_Write_Reg(NRF_WRITE_REG+CONFIG, 0x0f);//ÅäÖÃ»ù±¾¹¤×÷Ä£Ê½µÄ²ÎÊý;PWR_UP,EN_CRC,16BIT_CRC,½ÓÊÕÄ£Ê½ 
 241   1              
 242   1              NRF24L01_CE = 1; //CEÎª¸ß,½øÈë½ÓÊÕÄ£Ê½ 
 243   1      }
 244          
 245          /**********************************************************************
 246          -  Function :           void NRF24L01_TX_Mode(void)
 247          -  Description :        ³õÊ¼»¯NRF24L01µ½RXÄ£Ê½
 248          -  Input :                      void
 249          -  Return :                     void
 250          -  Others :                     
 251          **********************************************************************/
 252          void NRF24L01_TX_Mode(void)
 253          {                                                                                                                
 254   1              NRF24L01_CE=0;//Ê¹ÄÜNRF24L01    
 255   1              NRF24L01_Write_Buf(NRF_WRITE_REG+TX_ADDR, 
 256   1                      (uint8_t*)TX_ADDRESS, TX_ADR_WIDTH);//Ð´ÈëTX½ÚµãµØÖ· 
 257   1              NRF24L01_Write_Buf(NRF_WRITE_REG+RX_ADDR_P0, 
 258   1                      (uint8_t*)RX_ADDRESS, RX_ADR_WIDTH); //ÉèÖÃTX½ÚµãµØÖ·,Ö÷ÒªÎªÁËÊ¹ÄÜACK     
 259   1      
 260   1              NRF24L01_Write_Reg(NRF_WRITE_REG+EN_AA, 0x01);     //Ê¹ÄÜÍ¨µÀ0µÄ×Ô¶¯Ó¦´ð    
 261   1              NRF24L01_Write_Reg(NRF_WRITE_REG+EN_RXADDR, 0x01); //Ê¹ÄÜÍ¨µÀ0µÄ½ÓÊÕµØÖ·  
 262   1              NRF24L01_Write_Reg(NRF_WRITE_REG+SETUP_RETR, 0x1a);//ÉèÖÃ×Ô¶¯ÖØ·¢¼ä¸ôÊ±¼ä:500us + 86us;×î´ó×Ô¶¯ÖØ·¢´ÎÊý:1
             -0´Î
 263   1              NRF24L01_Write_Reg(NRF_WRITE_REG+RF_CH, 40);       //ÉèÖÃRFÍ¨µÀÎª40
 264   1              NRF24L01_Write_Reg(NRF_WRITE_REG+RF_SETUP, 0x0f);  //ÉèÖÃTX·¢Éä²ÎÊý,0dbÔöÒæ,2Mbps,µÍÔëÉùÔöÒæ¿ªÆô   
 265   1              NRF24L01_Write_Reg(NRF_WRITE_REG+CONFIG, 0x0e);    //ÅäÖÃ»ù±¾¹¤×÷Ä£Ê½µÄ²ÎÊý;PWR_UP,EN_CRC,16BIT_CRC,½ÓÊÕÄ
             -£Ê½,¿ªÆôËùÓÐÖÐ¶Ï
 266   1              NRF24L01_CE=1;//CEÎª¸ß,10usºóÆô¶¯·¢ËÍ
 267   1      }
 268          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    485    ----
   CONSTANT SIZE    =      5    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12      26
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
