C51 COMPILER V9.56.0.0   SPI                                                               01/02/2019 22:57:31 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE SPI
OBJECT MODULE PLACED IN ..\OBJ\spi.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_v5\C51\BIN\C51.EXE ..\SYSTEM\spi\spi.c OPTIMIZE(8,SPEED) BROWSE INCDIR(
                    -..\USER;..\SYSTEM;..\SYSTEM\delay;..\SYSTEM\uart;..\SYSTEM\adc;..\SYSTEM\eeprom;..\SYSTEM\timer;..\SYSTEM\pca;..\SYSTEM\
                    -spi;..\HARDWARE\NRF24L01;..\HARDWARE\Rocker;..\APP\NRF_DT) DEFINE(STC_Y5,FOSC=11059200L,UART_BAUD=115200,UART_PARITYBIT=
                    -ODD_PARITY,TEST_MODE=1,NRF_CAR_SLAVE,ROCKER_SUM=1) DEBUG OBJECTEXTEND PRINT(.\Listings\spi.lst) OBJECT(..\OBJ\spi.obj)

line level    source

   1          /**********************************************************************
   2          -  File name : spi.c
   3          -  Author : yueling_liu Version: 0.1    Date: 2018年10月01日星期一
   4          -  Description :        硬件SPI
   5          -  History :
   6             NO.<author>          <time>          <version>       <desc>
   7             1.yueling_liu        18/10/01        0.1                     project initial
   8          **********************************************************************/
   9          
  10          #include "spi.h"
  11          
  12          volatile bit SPI_Busy_Flag = 1;
  13          
  14          /**********************************************************************
  15          -  Function :           void SPI_Init(void)
  16          -  Description :        SPI Init
  17          -  Input :                      void
  18          -  Return :                     void
  19          -  Others :                     
  20          **********************************************************************/
  21          void SPI_Init(void)
  22          {
  23   1              SPDAT = 0x00;//初始化SPI数据
  24   1      
  25   1      //      #define SFR_SPSTAT_PSIF_INIT    1       //传输完成标志
  26   1      //      #define SFR_SPSTAT_WCOL_INIT    1       //SPI写冲突
  27   1      //      SPSTAT = (SFR_SPSTAT_PSIF_INIT<<7)|(SFR_SPSTAT_WCOL_INIT<<6);
  28   1              
  29   1      //      SPSTAT = 0xC0;
  30   1              
  31   1              SPSTAT = SPIF | WCOL;                           //清除SPI状态
  32   1              
  33   1      //      #define SFR_SPCTL_SSIG_INIT             1       //SFR_SPCTL_MSRT 确定器件为主机还是从机:由MSTR决定主从机
  34   1      //      #define SFR_SPCTL_SPEN_INIT             1       //SPI使能
  35   1      //      #define SFR_SPCTL_DORD_INIT             1       //数据顺序:MSB
  36   1      //      #define SFR_SPCTL_MSTR_INIT             1       //SPI Mode:Master
  37   1      //      #define SFR_SPCTL_CPOL_INIT             0       //SPI CPOL:串行同步时钟的空闲状态为低电平
  38   1      //      #define SFR_SPCTL_CPHA_INIT             0       //SPI CPHA:串行同步时钟的第1个跳变沿（上升或下降）数据被采样
  39   1      //      #define SFR_SPCTL_SPRx_INIT             0       //SPI SCLK: 0:CPU_CLK/4 = 11.0592MHz/4 = 2.7648MHz
  40   1      //      SPCTL =  (SFR_SPCTL_SSIG_INIT<<7)|(SFR_SPCTL_SPEN_INIT<<6)|(SFR_SPCTL_DORD_INIT<<5)
  41   1      //                      |(SFR_SPCTL_MSTR_INIT<<4)|(SFR_SPCTL_CPOL_INIT<<3)|(SFR_SPCTL_CPHA_INIT<<2)
  42   1      //                      | SFR_SPCTL_SPRx_INIT;
  43   1      //      SPCTL = 0xF0;
  44   1              
  45   1              SPCTL = SSIG | SPEN | MSTR;                     //设置SPI为主模式
  46   1              
  47   1              IE2 |= 0x02; //允许SPI中断
  48   1      }
  49          
  50          /**********************************************************************
  51          -  Function :           uint8_t SPI_ReadWriteByte(uint8_t TxData)
  52          -  Description :        SPI读写一个字节
C51 COMPILER V9.56.0.0   SPI                                                               01/02/2019 22:57:31 PAGE 2   

  53          -  Input :                      uint8_t TxData;发送字节
  54          -  Return :                     uint8_t RxData:接收字节
  55          -  Others :                     使用此函数前判断总线是否空闲;
  56                                                  SPI CS = 0;
  57          **********************************************************************/
  58          uint8_t SPI_ReadWriteByte(uint8_t TxData)
  59          {
  60   1              while(SPI_Busy_Flag);
  61   1              SPI_Busy_Flag = 1;              //SPI BUS Busy
  62   1              SPDAT = TxData;                 //触发SPI发送
  63   1              while(SPI_Busy_Flag);   //等待SPI数据传输完成
  64   1              
  65   1              return SPDAT;
  66   1      }
  67          
  68          /**********************************************************************
  69          -  Function :           void SPI_Interruption(void) interrupt 9
  70          -  Description :        SPI中断服务函数
  71          -  Input :                      void
  72          -  Return :                     void
  73          -  Others :                     
  74          **********************************************************************/
  75          void SPI_Interruption(void) interrupt 9
  76          {
  77   1              SPSTAT = 0x80|0x40;//清除SPI状态位
  78   1              
  79   1              SPI_Busy_Flag = 0;
  80   1      }
  81          
  82          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =     32    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
