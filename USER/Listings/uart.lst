C51 COMPILER V9.56.0.0   UART                                                              01/01/2019 22:52:34 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN ..\OBJ\uart.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_v5\C51\BIN\C51.EXE ..\SYSTEM\uart\uart.c OPTIMIZE(8,SPEED) BROWSE INCDI
                    -R(..\USER;..\SYSTEM;..\SYSTEM\delay;..\SYSTEM\uart;..\SYSTEM\adc;..\SYSTEM\eeprom;..\SYSTEM\timer;..\SYSTEM\pca;..\SYSTE
                    -M\spi;..\HARDWARE\NRF24L01;..\HARDWARE\Rocker;..\APP\NRF_DT) DEFINE(STC_Y5,FOSC=11059200L,UART_BAUD=115200,UART_PARITYBI
                    -T=ODD_PARITY,TEST_MODE=1,NRF_CAR_SLAVE,ROCKER_SUM=1) DEBUG OBJECTEXTEND PRINT(.\Listings\uart.lst) OBJECT(..\OBJ\uart.ob
                    -j)

line level    source

   1          /**********************************************************************
   2          -  File name : uart.c
   3          -  Author : yueling_liu Version: 0.1    Date: 2018.10.01 MO
   4          -  Description :        串口函数定义
   5          -  Function List :      
   6             1. void delay_us(const uint16_t xus);//us delay
   7             2. void delay_ms(const uint16_t xms);//ms delay
   8          -  History :
   9             NO.<author>          <time>          <version>       <desc>
  10             1.yueling_liu        18/10/01        0.1                     project initial
  11          **********************************************************************/
  12          
  13          //--Header File--//
  14          #include "uart.h"
  15          #include "delay.h"
  16          
  17          #define S1_S0 0x40              //P_SW1.6
  18          #define S1_S1 0x80              //P_SW1.7
  19          
  20          #define NONE_PARITY     0       //无校验
  21          #define ODD_PARITY      1       //奇校验
  22          #define EVEN_PARITY     2       //偶校验
  23          #define MARK_PARITY     3       //标记校验
  24          #define SPACE_PARITY    4       //空白校验
  25          
  26          //#define UART_PARITYBIT  NONE_PARITY   //定义校验位
  27          
  28          volatile bit UART_Txd_Pre_OK_Flag = 1;  //上一次发送完成标志
  29          
  30          /**********************************************************************
  31          -  Function :           void UART_Init(void)
  32          -  Description :        UART
  33          -  Input :                      void
  34          -  Return :                     void
  35          -  Others :                     Timer 2; UART 中断优先;
  36          **********************************************************************/
  37          void UART_Init(void)
  38          {
  39   1              uint8_t Buff;
  40   1              
  41   1              Buff = P_SW1;
  42   1          Buff &= ~(S1_S0 | S1_S1);    //S1_S0=0 S1_S1=0
  43   1          P_SW1 = Buff;                //(P3.0/RxD, P3.1/TxD)
  44   1          
  45   1      //  Buff = P_SW1;
  46   1      //  Buff &= ~(S1_S0 | S1_S1);    //S1_S0=1 S1_S1=0
  47   1      //  Buff |= S1_S0;               //(P3.6/RxD_2, P3.7/TxD_2)
  48   1      //  P_SW1 = Buff;  
  49   1      //  
  50   1      //  Buff = P_SW1;
  51   1      //  Buff &= ~(S1_S0 | S1_S1);    //S1_S0=0 S1_S1=1
C51 COMPILER V9.56.0.0   UART                                                              01/01/2019 22:52:34 PAGE 2   

  52   1      //  Buff |= S1_S1;               //(P1.6/RxD_3, P1.7/TxD_3)
  53   1      //  P_SW1 = Buff; 
  54   1              
  55   1      #if (UART_PARITYBIT == NONE_PARITY)
                  SCON = 0x50;                //8位可变波特率
              #elif (UART_PARITYBIT == ODD_PARITY) || (UART_PARITYBIT == EVEN_PARITY) \
                      || (UART_PARITYBIT == MARK_PARITY)
  59   1          SCON = 0xda;                //9位可变波特率,校验位初始为1
  60   1      #elif (UART_PARITYBIT == SPACE_PARITY)
                  SCON = 0xd2;                //9位可变波特率,校验位初始为0
              #endif
  63   1              
  64   1          T2L = (65536 - (FOSC/4/UART_BAUD));   //设置波特率重装值
  65   1          T2H = (65536 - (FOSC/4/UART_BAUD))>>8;
  66   1          AUXR = 0x14;                //T2为1T模式, 并启动定时器2
  67   1          AUXR |= 0x01;               //选择定时器2为串口1的波特率发生器
  68   1          PS = 1;                     //串口中断优先
  69   1                      ES = 1;                 //使能串口1中断
  70   1      }
  71          
  72          /**********************************************************************
  73          -  Function :           void UART_SendData(const uint8_t Data)
  74          -  Description :        UART发送8bit数据
  75          -  Input :                      const uint8_t Data;
  76          -  Return :                     void
  77          -  Others :                     校验全局定义在
  78          **********************************************************************/
  79          void UART_SendData(const uint8_t Data)
  80          {       
  81   1              uint8_t buff;
  82   1              
  83   1              while(1)
  84   1              {
  85   2                      if(UART_Txd_Pre_OK_Flag == 1)//上一次数据发送完成
  86   2                      {
  87   3                              UART_Txd_Pre_OK_Flag = 0;
  88   3                              EA = 0;
  89   3                              buff = Data;
  90   3                              if (buff&0x01 == 0x01)                     //根据P来设置校验位
  91   3                              {
  92   4      #if (UART_PARITYBIT == ODD_PARITY)
  93   4                                      TB8 = 0;                //设置校验位为0
  94   4      #elif (UART_PARITYBIT == EVEN_PARITY)
                                              TB8 = 1;                //设置校验位为1
              #endif
  97   4                              }
  98   3                              else
  99   3                              {
 100   4      #if (UART_PARITYBIT == ODD_PARITY)
 101   4                                      TB8 = 1;                //设置校验位为1
 102   4      #elif (UART_PARITYBIT == EVEN_PARITY)
                                              TB8 = 0;                //设置校验位为0
              #endif
 105   4                              }
 106   3                              EA = 1;
 107   3                              
 108   3                              SBUF = Data;
 109   3                              return ;
 110   3                      }
 111   2              }
 112   1      }
 113          
C51 COMPILER V9.56.0.0   UART                                                              01/01/2019 22:52:34 PAGE 3   

 114          
 115          /**********************************************************************
 116          -  Function :           void UART_SendString(uint8_t *Str)
 117          -  Description :        UART发送字符串函数
 118          -  Input :                      uint8_t *Str
 119          -  Return :                     void    
 120          -  Others :                     
 121          **********************************************************************/
 122          void UART_SendString(uint8_t *Str)
 123          {
 124   1      #if (TEST_MODE == 1)    //TEST
 125   1              while(*Str != '\0')
 126   1              {
 127   2                      UART_SendData(*Str++);
 128   2              }
 129   1      #endif
 130   1      }
 131          
 132          
 133          
 134          /**********************************************************************
 135          -  Function :           void InterruptUART() interrupt 4 using 1
 136          -  Description :        UART中断服务函数
 137          -  Input :                      void
 138          -  Return :                     void    
 139          -  Others :                     占用T2定时器; UART中断优先级最高; 中断4;
 140          **********************************************************************/
 141          void UART_Time1_Interruption(void) interrupt 4
 142          {
 143   1          if (RI)
 144   1          {
 145   2              RI = 0;                 //清除RI位
 146   2          }
 147   1          if (TI)
 148   1          {
 149   2              TI = 0;                 //清除TI位
 150   2              UART_Txd_Pre_OK_Flag = 1;//发送完成置发送完成标志
 151   2          }
 152   1      }
 153          
 154          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =     99    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
